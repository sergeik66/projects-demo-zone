target:
  lakehouse: den_lhw_dpr_001_claims_transaction
  schema: claims_transaction
  table: dim_adjuster
  load_strategy: type_two
  key_columns:
    - adjustr_bus_key
  unknown_record: True
  identity: True
  identity_column_name: adjustr_key
  
source:
  - name: claimant
    lakehouse: den_lhw_scu_001_claims_transaction_curated
    schema: iis_transaction
    table: claimant

  - name: employee
    lakehouse: den_lhw_scu_001_claims_transaction_curated
    schema: iis_transaction
    table: employee

  - name: lookups
    lakehouse: den_lhw_scu_001_claims_transaction_curated
    schema: iis_transaction
    table: lookups

  - name: provider
    lakehouse: den_lhw_scu_001_claims_transaction_curated
    schema: iis_transaction
    table: provider

  - name: provtype
    lakehouse: den_lhw_scu_001_claims_transaction_curated
    schema: iis_transaction
    table: provtype

  - name: reservelimits
    lakehouse: den_lhw_scu_001_claims_transaction_curated
    schema: iis_transaction
    table: reservelimits

  - name: wcclaim
    lakehouse: den_lhw_scu_001_claims_transaction_curated
    schema: iis_transaction
    table: wcclaim

query:
  - name: dim_adjuster
    sql: |
      SELECT DISTINCT 
        CONCAT('EMP-', e.empcode,'-', COALESCE(UPPER(TRIM(r.coveragecategory)), UPPER(TRIM(w.coveragecategory)))) as adjustr_bus_key,
        e.name as adjustr_nm,
        e.empcode as adjustr_cd,
        e.emptype as adjustr_type_cd,
        l.descrip as adjustr_type_desc,
        0 as adjustr_tpa_flg,
        COALESCE(r.userid, 0) as reserve_entry_userid,
        COALESCE(r.coveragecategory, 'NA') as reserve_limit_cvrg_ctgry,
        COALESCE(r.totallimit, 0) as reserve_limit_amt

      FROM claimant c
      INNER JOIN employee e ON UPPER(TRIM(c.adjustor)) = UPPER(TRIM(e.empcode)) AND e.dl_iscurrent = 1
      INNER JOIN wcclaim w ON c.wcclaimid = w.wcclaimid AND w.dl_iscurrent = 1
      LEFT JOIN lookups l ON UPPER(TRIM(e.emptype)) = UPPER(TRIM(l.vals)) and UPPER(TRIM(l.keyfield)) = 'EMPTYPE' AND l.dl_iscurrent = 1
      LEFT JOIN reservelimits r ON e.userid = r.userid AND UPPER(TRIM(r.coveragecategory)) = UPPER(TRIM(w.coveragecategory)) AND r.dl_iscurrent = 1

      UNION ALL

      SELECT DISTINCT 
        CONCAT('TPA-', p.provider) as adjustr_bus_key,
        CONCAT(TRIM(p.name), '(', TRIM(p.county), ')') as adjustr_nm,
        p.provider as adjustr_cd,
        pt.provtype as adjustr_type_cd,
        pt.provtypdes as adjustr_type_desc,
        1 as adjustr_tpa_flg,
        0 as reserve_entry_userid,
        'NA' as reserve_limit_cvrg_ctgry,
        0 as reserve_limit_amt
      FROM claimant c
      INNER JOIN provider p ON UPPER(TRIM(c.tpataxid)) = UPPER(TRIM(p.provider)) AND p.dl_iscurrent = 1
      INNER JOIN provtype pt ON UPPER(TRIM(p.provtype)) = UPPER(TRIM(pt.provtype)) AND pt.dl_iscurrent = 1
      ORDER BY adjustr_bus_key

    description: "This query creates a dimension table for adjusters, combining both internal employees and third-party administrators (TPAs) into a unified dimension. It provides adjuster details (name, code, type) and distinguishes between internal staff and external TPAs using a flag. The business key prefixes ('EMP-' and 'TPA-') identify the adjuster source."
    
